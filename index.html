<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#001f3f">
    <meta name="description" content="V-PAY - Secure Payment Processing Platform">
    <title>V-PAY - Secure Payments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/GtHqWWbV/wallet.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --navy: #001f3f;
            --navy-light: #003366;
            --navy-lighter: #00478a;
            --white: #ffffff;
            --black: #000000;
            --gray-light: #f8f9fa;
            --gray: #e0e0e0;
            --gray-dark: #666666;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--navy) 0%, var(--black) 100%);
            color: var(--black);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .main-content {
            padding: 15px;
            padding-bottom: 80px;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 0;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--white);
        }

        .logo {
            width: 45px;
            height: 45px;
            background: var(--white);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--navy);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.4em;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--white);
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--navy);
            overflow: hidden;
            cursor: pointer;
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .nav-icon.active {
            background: var(--navy-light);
            color: var(--white);
        }

        .nav-icon i {
            font-size: 20px;
        }

        .nav-icon span {
            font-size: 11px;
            font-weight: 500;
        }

        /* Payment Flow Styles */
        .payment-flow {
            max-width: 450px;
            margin: 0 auto;
        }

        .flow-step {
            display: none;
        }

        .flow-step.active {
            display: block;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .welcome-section {
            background: var(--white);
            border-radius: 14px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            text-align: center;
        }

        .welcome-title {
            color: var(--navy);
            margin-bottom: 12px;
            font-size: 1.4em;
            font-weight: 600;
        }

        .welcome-text {
            color: var(--gray-dark);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .category-card {
            background: var(--white);
            border-radius: 12px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }

        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: var(--navy);
        }

        .category-icon {
            font-size: 2.8em;
            margin-bottom: 15px;
            color: var(--navy);
        }

        .category-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--navy);
        }

        /* Business Grid */
        .business-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .business-card {
            background: var(--white);
            border-radius: 12px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }

        .business-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: var(--navy);
        }

        .business-card.selected {
            border-color: var(--navy);
            background: var(--navy-light);
        }

        .business-card.selected .business-icon,
        .business-card.selected .business-name {
            color: var(--white);
        }

        .business-icon {
            font-size: 2.8em;
            margin-bottom: 15px;
            color: var(--navy);
        }

        .business-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--navy);
        }

        /* Amount Input */
        .amount-section {
            text-align: center;
            margin: 30px 0;
        }

        .amount-input {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            padding: 25px;
            border: 3px solid var(--gray);
            border-radius: 16px;
            width: 100%;
            max-width: 280px;
            margin: 0 auto 20px;
            display: block;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .amount-input:focus {
            border-color: var(--navy);
            box-shadow: 0 0 0 4px rgba(0, 31, 63, 0.1);
            outline: none;
        }

        .currency-label {
            color: var(--white);
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        /* Payment Methods */
        .payment-methods {
            margin: 25px 0;
        }

        .payment-method-card {
            background: var(--white);
            border: 2px solid var(--gray);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method-card.active {
            border-color: var(--navy);
            background: var(--gray-light);
        }

        .payment-method-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .payment-method-icon {
            font-size: 1.6em;
            color: var(--navy);
        }

        .payment-method-name {
            font-weight: 600;
            color: var(--navy);
            font-size: 16px;
        }

        .payment-details-card {
            background: var(--navy);
            color: var(--white);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-details-text {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 600;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Confirmation */
        .confirmation-details {
            background: var(--white);
            border-radius: 14px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--gray-dark);
            font-weight: 600;
        }

        .detail-value {
            color: var(--navy);
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 18px;
            background: var(--navy);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        .btn:hover {
            background: var(--navy-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: var(--gray-dark);
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-back {
            background: transparent;
            color: var(--navy);
            border: 2px solid var(--navy);
        }

        .btn-back:hover {
            background: var(--navy);
            color: var(--white);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--navy);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--gray);
            border-radius: 10px;
            font-size: 15px;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(0, 31, 63, 0.1);
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gray);
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: var(--navy);
        }

        .step.completed .step-number {
            background: var(--success);
        }

        .step-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-dark);
            text-align: center;
        }

        .step.active .step-label {
            color: var(--navy);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 15px;
        }

        .modal-text {
            color: var(--gray-dark);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }
            
            .category-grid,
            .business-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .category-card,
            .business-card {
                padding: 20px 15px;
            }
            
            .amount-input {
                font-size: 2em;
                padding: 20px;
            }
            
            .modal-content {
                padding: 25px 20px;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
        <div class="modal-content">
            <div class="modal-icon" style="color: #28a745;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="modal-title">Payment Successful!</h2>
            <p class="modal-text" id="successMessage">Your payment has been processed successfully. A receipt has been sent to your email.</p>
            <button class="btn btn-success" onclick="closeSuccessModal()">
                <i class="fas fa-check"></i> Done
            </button>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="modal-overlay" id="welcomeModal">
        <div class="modal-content">
            <div class="modal-icon" style="color: #001f3f;">
                <i class="fas fa-wallet"></i>
            </div>
            <h2 class="modal-title">Welcome to V-PAY</h2>
            <p class="modal-text">Sign in to access secure payments and track your transactions.</p>
            <div id="g_id_onload"
                data-client_id="286681909528-ca5egn614i94vgh2p3ejrov1r53hn8v8.apps.googleusercontent.com"
                data-context="signin"
                data-ux_mode="popup"
                data-callback="handleGoogleSignIn"
                data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                data-type="standard"
                data-shape="rectangular"
                data-theme="filled_blue"
                data-text="signin_with"
                data-size="large"
                data-logo_alignment="left">
            </div>
        </div>
    </div>

    <!-- App Content -->
    <div class="app-content" id="appContent">
        <div class="app-container">
            <div class="main-content">
                <!-- Top Bar -->
                <div class="top-bar">
                    <div class="logo-container">
                        <div class="logo">
                            <img src="https://i.postimg.cc/GtHqWWbV/wallet.png" alt="V-PAY" style="width: 30px; height: 30px;">
                        </div>
                        <div class="logo-text">V-PAY</div>
                    </div>
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>

                <!-- Home Page -->
                <div class="page active" id="home">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div class="welcome-section">
                            <h2 class="welcome-title">Welcome to V-PAY</h2>
                            <p class="welcome-text">Secure, fast, and reliable payment processing at your fingertips.</p>
                        </div>
                        
                        <!-- Exchange rates and other dashboard content can go here -->
                        <div style="text-align: center; color: white; margin-top: 40px;">
                            <h3>Your Payment Dashboard</h3>
                            <p>Select Payments below to get started</p>
                        </div>
                    </div>
                </div>

                <!-- Payments Page -->
                <div class="page" id="payments">
                    <div class="payment-flow">
                        <!-- Step 1: Service Categories -->
                        <div class="flow-step active" id="stepCategories">
                            <div class="welcome-section">
                                <h2 class="welcome-title">What would you like to pay for?</h2>
                                <p class="welcome-text">Select a category to continue</p>
                            </div>

                            <div class="category-grid">
                                <div class="category-card" onclick="selectCategory('shopping')">
                                    <div class="category-icon">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                    <div class="category-name">Shopping</div>
                                </div>
                                <div class="category-card" onclick="selectCategory('tickets')">
                                    <div class="category-icon">
                                        <i class="fas fa-ticket-alt"></i>
                                    </div>
                                    <div class="category-name">Tickets</div>
                                </div>
                                <div class="category-card" onclick="selectCategory('subscriptions')">
                                    <div class="category-icon">
                                        <i class="fas fa-sync-alt"></i>
                                    </div>
                                    <div class="category-name">Subscriptions</div>
                                </div>
                                <div class="category-card" onclick="selectCategory('rent')">
                                    <div class="category-icon">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div class="category-name">Rent</div>
                                </div>
                                <div class="category-card" onclick="selectCategory('services')">
                                    <div class="category-icon">
                                        <i class="fas fa-concierge-bell"></i>
                                    </div>
                                    <div class="category-name">Services</div>
                                </div>
                                <div class="category-card" onclick="selectCategory('other')">
                                    <div class="category-icon">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </div>
                                    <div class="category-name">Other</div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Business Selection -->
                        <div class="flow-step" id="stepBusiness">
                            <div class="welcome-section">
                                <h2 class="welcome-title" id="businessTitle">Select Business</h2>
                                <p class="welcome-text">Choose where you want to send payment</p>
                                <button class="btn btn-back" onclick="goToStep('stepCategories')">
                                    <i class="fas fa-arrow-left"></i> Back to Categories
                                </button>
                            </div>

                            <div class="business-grid" id="businessGrid">
                                <!-- Businesses will be loaded here -->
                            </div>
                        </div>

                        <!-- Step 3: Amount -->
                        <div class="flow-step" id="stepAmount">
                            <div class="welcome-section">
                                <h2 class="welcome-title">Enter Amount</h2>
                                <p class="welcome-text" id="amountSubtitle">How much would you like to pay?</p>
                                <button class="btn btn-back" onclick="goToStep('stepBusiness')">
                                    <i class="fas fa-arrow-left"></i> Change Business
                                </button>
                            </div>

                            <div class="progress-steps">
                                <div class="step active">
                                    <div class="step-number">1</div>
                                    <div class="step-label">Amount</div>
                                </div>
                                <div class="step">
                                    <div class="step-number">2</div>
                                    <div class="step-label">Pay</div>
                                </div>
                                <div class="step">
                                    <div class="step-number">3</div>
                                    <div class="step-label">Confirm</div>
                                </div>
                            </div>

                            <div class="amount-section">
                                <div class="currency-label">Amount in Kenyan Shillings</div>
                                <input type="number" class="amount-input" id="paymentAmount" placeholder="0" min="1" autofocus>
                            </div>

                            <button class="btn" onclick="validateAmount()">
                                Continue to Payment <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>

                        <!-- Step 4: Payment Method -->
                        <div class="flow-step" id="stepPayment">
                            <div class="welcome-section">
                                <h2 class="welcome-title">Payment Method</h2>
                                <p class="welcome-text">Choose how you want to pay</p>
                                <button class="btn btn-back" onclick="goToStep('stepAmount')">
                                    <i class="fas fa-arrow-left"></i> Change Amount
                                </button>
                            </div>

                            <div class="progress-steps">
                                <div class="step completed">
                                    <div class="step-number"><i class="fas fa-check"></i></div>
                                    <div class="step-label">Amount</div>
                                </div>
                                <div class="step active">
                                    <div class="step-number">2</div>
                                    <div class="step-label">Pay</div>
                                </div>
                                <div class="step">
                                    <div class="step-number">3</div>
                                    <div class="step-label">Confirm</div>
                                </div>
                            </div>

                            <div class="payment-methods" id="paymentMethods">
                                <!-- Payment methods will be loaded here -->
                            </div>

                            <button class="btn" onclick="goToStep('stepConfirm')">
                                Continue to Confirmation <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>

                        <!-- Step 5: Confirmation -->
                        <div class="flow-step" id="stepConfirm">
                            <div class="welcome-section">
                                <h2 class="welcome-title">Confirm Payment</h2>
                                <p class="welcome-text">Review and submit your payment</p>
                                <button class="btn btn-back" onclick="goToStep('stepPayment')">
                                    <i class="fas fa-arrow-left"></i> Change Method
                                </button>
                            </div>

                            <div class="progress-steps">
                                <div class="step completed">
                                    <div class="step-number"><i class="fas fa-check"></i></div>
                                    <div class="step-label">Amount</div>
                                </div>
                                <div class="step completed">
                                    <div class="step-number"><i class="fas fa-check"></i></div>
                                    <div class="step-label">Pay</div>
                                </div>
                                <div class="step active">
                                    <div class="step-number">3</div>
                                    <div class="step-label">Confirm</div>
                                </div>
                            </div>

                            <div class="confirmation-details">
                                <div class="detail-row">
                                    <span class="detail-label">Business</span>
                                    <span class="detail-value" id="confirmBusiness">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Amount</span>
                                    <span class="detail-value" id="confirmAmount">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Payment Method</span>
                                    <span class="detail-value" id="confirmMethod">-</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Transaction Reference Number</label>
                                <input type="text" class="form-input" id="transactionId" placeholder="Enter M-PESA code" required>
                                <small style="color: var(--gray-dark); margin-top: 5px; display: block;">
                                    Enter the code you received after payment
                                </small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Additional Notes (Optional)</label>
                                <textarea class="form-input" id="paymentNotes" placeholder="Any additional information" rows="3"></textarea>
                            </div>

                            <button class="btn btn-success" onclick="submitPayment()">
                                <i class="fas fa-paper-plane"></i> Submit Payment
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Other pages (Wallet, Transactions) -->
                <div class="page" id="wallet">
                    <div class="welcome-section">
                        <h2 class="welcome-title">Wallet Coming Soon</h2>
                        <p class="welcome-text">We're building a secure digital wallet for all your payment needs.</p>
                    </div>
                </div>

                <div class="page" id="transactions">
                    <div class="welcome-section">
                        <h2 class="welcome-title">Transaction History</h2>
                        <p class="welcome-text">View your payment history and receipts.</p>
                    </div>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
                <div class="nav-icon active" onclick="showPage('home')">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </div>
                <div class="nav-icon" onclick="showPage('payments')">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </div>
                <div class="nav-icon" onclick="showPage('wallet')">
                    <i class="fas fa-wallet"></i>
                    <span>Wallet</span>
                </div>
                <div class="nav-icon" onclick="showPage('transactions')">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbycDPMAhgMwuuchAlTMT0hGGgIMpcUejdeapcSAVk9raWITFJpLKdQaxbociiS3a16CAg/exec';
        
        // Business Data
        const businesses = {
            'dsogstores': {
                name: "DSOG Stores",
                email: "office.dsog@gmail.com",
                icon: "fas fa-store",
                paymentMethods: [
                    {
                        type: 'mpesa-till',
                        name: 'Lipa Na M-PESA',
                        details: '6719216',
                        description: 'Till Number'
                    }
                ]
            },
            'thesonga': {
                name: "The Songa",
                email: "office.songawelfare@gmail.com",
                icon: "fas fa-music",
                paymentMethods: [
                    {
                        type: 'mpesa-send',
                        name: 'M-PESA Send Money',
                        details: '0727211191',
                        description: 'Phone Number'
                    }
                ]
            },
            'workfitclub': {
                name: "WorkFit Club",
                email: "finance.workfit@gmail.com",
                icon: "fas fa-dumbbell",
                paymentMethods: [
                    {
                        type: 'mpesa-send',
                        name: 'M-PESA Send Money',
                        details: '0784599322',
                        description: 'Phone Number'
                    }
                ]
            },
            'hekimahub': {
                name: "Hekima Hub",
                email: "finance.hekimahub@gmail.com",
                icon: "fas fa-book",
                paymentMethods: [
                    {
                        type: 'mpesa-till',
                        name: 'Lipa Na M-PESA',
                        details: '9442155',
                        description: 'Till Number'
                    }
                ]
            },
            'fusionstores': {
                name: "Fusion Stores",
                email: "teleioofusion@gmail.com",
                icon: "fas fa-fire",
                paymentMethods: [
                    {
                        type: 'mpesa-till',
                        name: 'Lipa Na M-PESA',
                        details: '9442155',
                        description: 'Till Number'
                    }
                ]
            }
        };

        // Current Payment Session
        let currentPayment = {
            category: '',
            business: null,
            amount: '',
            method: null,
            transactionId: '',
            notes: ''
        };

        // App State
        let currentUser = null;

        // Payment Flow Functions
        function selectCategory(category) {
            currentPayment.category = category;
            document.getElementById('businessTitle').textContent = `Select Business - ${category.charAt(0).toUpperCase() + category.slice(1)}`;
            loadBusinessGrid();
            goToStep('stepBusiness');
        }

        function loadBusinessGrid() {
            const grid = document.getElementById('businessGrid');
            grid.innerHTML = Object.entries(businesses).map(([key, business]) => `
                <div class="business-card" onclick="selectBusiness('${key}')">
                    <div class="business-icon">
                        <i class="${business.icon}"></i>
                    </div>
                    <div class="business-name">${business.name}</div>
                </div>
            `).join('');
        }

        function selectBusiness(businessKey) {
            currentPayment.business = businesses[businessKey];
            document.getElementById('amountSubtitle').textContent = `Payment to ${currentPayment.business.name}`;
            goToStep('stepAmount');
        }

        function validateAmount() {
            const amount = document.getElementById('paymentAmount').value;
            if (!amount || amount < 1) {
                alert('Please enter a valid amount');
                return;
            }
            currentPayment.amount = amount;
            loadPaymentMethods();
            goToStep('stepPayment');
        }

        function loadPaymentMethods() {
            const container = document.getElementById('paymentMethods');
            if (!currentPayment.business) return;

            container.innerHTML = currentPayment.business.paymentMethods.map((method, index) => `
                <div class="payment-method-card ${index === 0 ? 'active' : ''}" 
                     onclick="selectPaymentMethod(this, '${method.type}')">
                    <div class="payment-method-header">
                        <div class="payment-method-icon">
                            <i class="${getMethodIcon(method.type)}"></i>
                        </div>
                        <div class="payment-method-name">${method.name}</div>
                    </div>
                    <div class="payment-details-card">
                        <div class="payment-details-text">${method.description}: ${method.details}</div>
                        <button class="copy-btn" onclick="copyToClipboard('${method.details}', event)">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
            `).join('');

            // Auto-select first method
            if (currentPayment.business.paymentMethods.length > 0) {
                currentPayment.method = currentPayment.business.paymentMethods[0];
            }
        }

        function selectPaymentMethod(element, methodType) {
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('active');
            });
            element.classList.add('active');
            
            currentPayment.method = currentPayment.business.paymentMethods.find(m => m.type === methodType);
        }

        function goToStep(stepId) {
            // Hide all steps
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show target step
            document.getElementById(stepId).classList.add('active');

            // Update confirmation details if going to confirmation step
            if (stepId === 'stepConfirm') {
                updateConfirmationDetails();
            }
        }

        function updateConfirmationDetails() {
            document.getElementById('confirmBusiness').textContent = currentPayment.business.name;
            document.getElementById('confirmAmount').textContent = `KES ${currentPayment.amount}`;
            document.getElementById('confirmMethod').textContent = currentPayment.method ? currentPayment.method.name : 'Not selected';
        }

        async function submitPayment() {
            const transactionId = document.getElementById('transactionId').value;
            if (!transactionId) {
                alert('Please enter your transaction reference number');
                return;
            }

            currentPayment.transactionId = transactionId;
            currentPayment.notes = document.getElementById('paymentNotes').value;

            try {
                const formData = {
                    timestamp: new Date().toLocaleString('en-KE'),
                    customerName: currentUser.name,
                    customerEmail: currentUser.email,
                    paymentDestination: currentPayment.business.name,
                    businessEmail: currentPayment.business.email,
                    paymentCategory: currentPayment.category,
                    amount: currentPayment.amount,
                    paymentMethod: currentPayment.method.name,
                    transactionId: currentPayment.transactionId,
                    notes: currentPayment.notes,
                    status: 'pending_verification',
                    userId: currentUser.id
                };

                // Send to Google Apps Script
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                // Save locally
                savePaymentToStorage(formData);
                
                // Show success
                showSuccessModal('Payment submitted successfully! Receipt sent to your email.');

            } catch (error) {
                console.error('Payment error:', error);
                showSuccessModal('Payment details saved. Business will contact you for verification.');
            }
        }

        function getMethodIcon(methodType) {
            const icons = {
                'mpesa-till': 'fas fa-store',
                'mpesa-send': 'fas fa-paper-plane'
            };
            return icons[methodType] || 'fas fa-money-bill-wave';
        }

        async function copyToClipboard(text, event) {
            event.stopPropagation();
            try {
                await navigator.clipboard.writeText(text);
                // Show some visual feedback
                const btn = event.target.closest('.copy-btn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => { btn.innerHTML = originalHtml; }, 2000);
            } catch (err) {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }

        function savePaymentToStorage(paymentData) {
            const key = `vpay_transactions_${currentUser.id}`;
            const payments = JSON.parse(localStorage.getItem(key) || '[]');
            payments.push({
                ...paymentData,
                id: Date.now().toString(),
                offlineTimestamp: new Date().toISOString()
            });
            localStorage.setItem(key, JSON.stringify(payments));
        }

        function showSuccessModal(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
            resetPaymentFlow();
            showPage('home');
        }

        function resetPaymentFlow() {
            currentPayment = {
                category: '',
                business: null,
                amount: '',
                method: null,
                transactionId: '',
                notes: ''
            };
            
            // Reset form fields
            document.getElementById('paymentAmount').value = '';
            document.getElementById('transactionId').value = '';
            document.getElementById('paymentNotes').value = '';
            
            // Go back to categories
            goToStep('stepCategories');
        }

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            document.querySelector(`.nav-icon[onclick="showPage('${pageId}')"]`).classList.add('active');

            // Reset payment flow when entering payments page
            if (pageId === 'payments') {
                resetPaymentFlow();
            }
        }

        // Authentication
        function handleGoogleSignIn(response) {
            const payload = parseJwt(response.credential);
            currentUser = {
                name: payload.name,
                email: payload.email,
                picture: payload.picture,
                id: payload.sub
            };
            
            localStorage.setItem('vpay_current_user', JSON.stringify(currentUser));
            document.getElementById('appContent').style.display = 'block';
            document.getElementById('welcomeModal').style.display = 'none';
            
            // Update avatar if available
            if (currentUser.picture) {
                document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.picture}" alt="User" style="width: 100%; height: 100%; border-radius: 50%;">`;
            }
        }

        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return {};
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('vpay_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('appContent').style.display = 'block';
                if (currentUser.picture) {
                    document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.picture}" alt="User" style="width: 100%; height: 100%; border-radius: 50%;">`;
                }
            } else {
                document.getElementById('welcomeModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>
